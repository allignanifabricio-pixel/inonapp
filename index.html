<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Ingresos y Egresos</title>
<link rel="manifest" href="manifest.json">

<style>
:root {
    --bg:#ffffff;
    --text:#000000;
    --primary:#1976d2;
}

body.dark{
    --bg:#121212;
    --text:#ffffff;
}

body{
    margin:0;
    font-family:Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
    transition:.3s;
    overflow-x:hidden;
}

header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:12px;
    background:var(--primary);
    color:white;
}

#monthTitle{
    text-align:center;
    padding:8px;
    font-weight:bold;
    text-transform:capitalize;
}

#grid{
    padding:8px;
}

.row{
    display:grid;
    grid-template-columns: 70px 1fr 65px 65px;
    gap:4px;
    padding:8px 4px;
    font-size:14px;
    border-bottom:1px solid #ddd;
    align-items:center;
    word-break:break-word;
}

.total{
    font-weight:bold;
    border-top:2px solid gray;
    margin-top:5px;
}

.fab{
    position:fixed;
    bottom:20px;
    right:20px;
    width:55px;
    height:55px;
    border-radius:50%;
    border:none;
    background:var(--primary);
    color:white;
    font-size:28px;
    box-shadow:0 4px 8px rgba(0,0,0,.3);
}

#formContainer{
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    background:var(--bg);
    padding:15px;
    box-shadow:0 -4px 10px rgba(0,0,0,.2);
    display:none;
}

.formRow{
    display:flex;
    flex-direction:column;
    gap:8px;
}

.formRow input{
    padding:10px;
    font-size:16px;
}

.formRow button{
    padding:12px;
    font-size:16px;
    background:var(--primary);
    color:white;
    border:none;
}
</style>
</head>
<body>

<header>
    <div>Ingresos y Egresos</div>
    <button onclick="toggleDark()">ðŸŒ™</button>
</header>

<div id="monthTitle"></div>
<div id="grid"></div>

<button class="fab" onclick="toggleForm()">+</button>

<div id="formContainer">
    <div class="formRow">
        <input type="date" id="date">
        <input type="text" id="detail" placeholder="Detalle">
        <input type="number" id="debe" placeholder="Debe (egreso)">
        <input type="number" id="haber" placeholder="Haber (ingreso)">
        <button onclick="saveMovement()">Guardar</button>
    </div>
</div>

<script>
let currentDate = new Date();
let movements = JSON.parse(localStorage.getItem("movements") || "{}");
let startX = 0;
let editIndex = null;
let editKey = null;
let longPressTimer = null;

function save(){
    localStorage.setItem("movements", JSON.stringify(movements));
}

function getMonthKey(date){
    return date.getFullYear()+"-"+(date.getMonth()+1);
}

function getKeyFromDateInput(dateStr){
    const d = new Date(dateStr);
    return d.getFullYear()+"-"+(d.getMonth()+1);
}

function formatDate(dateStr){
    const d = new Date(dateStr);
    return d.toLocaleDateString("es-AR");
}

function render(){
    const grid=document.getElementById("grid");
    grid.innerHTML="";

    const key=getMonthKey(currentDate);
    const data=movements[key]||[];

    document.getElementById("monthTitle").innerText=
        currentDate.toLocaleString("es-ES",{month:"long",year:"numeric"});

    let total=0;

    data.forEach((m,index)=>{
        const row=document.createElement("div");
        row.className="row";
        row.innerHTML=`
            <div>${m.date}</div>
            <div>${m.detail}</div>
            <div>${m.debe||""}</div>
            <div>${m.haber||""}</div>
        `;

        /* EDITAR con toque */
        row.onclick=()=>loadEdit(index,key);

        /* BORRAR con pulsaciÃ³n larga */
        row.addEventListener("touchstart",()=>{
            longPressTimer=setTimeout(()=>{
                deleteMovement(index,key);
            },700);
        });

        row.addEventListener("touchend",()=>{
            clearTimeout(longPressTimer);
        });

        total+=(parseFloat(m.haber)||0)-(parseFloat(m.debe)||0);
        grid.appendChild(row);
    });

    const totalRow=document.createElement("div");
    totalRow.className="row total";
    totalRow.innerHTML=`
        <div></div>
        <div>Saldo</div>
        <div></div>
        <div>${total.toFixed(2)}</div>
    `;
    grid.appendChild(totalRow);
}

function toggleForm(){
    const form=document.getElementById("formContainer");
    form.style.display=form.style.display==="block"?"none":"block";
}

function saveMovement(){
    const date=document.getElementById("date").value;
    const detail=document.getElementById("detail").value;
    const debe=document.getElementById("debe").value;
    const haber=document.getElementById("haber").value;

    if(!date||!detail) return;

    const key=getKeyFromDateInput(date);
    const formatted=formatDate(date);

    if(!movements[key]) movements[key]=[];

    const movement={date:formatted,detail,debe,haber};

    if(editIndex!==null){
        movements[editKey].splice(editIndex,1);
        movements[key].push(movement);
        editIndex=null;
        editKey=null;
    }else{
        movements[key].push(movement);
    }

    save();
    clearForm();
    toggleForm();
    render();
}

function loadEdit(index,key){
    const m=movements[key][index];
    document.getElementById("detail").value=m.detail;
    document.getElementById("debe").value=m.debe;
    document.getElementById("haber").value=m.haber;

    const parts=m.date.split("/");
    document.getElementById("date").value=
        `${parts[2]}-${parts[1]}-${parts[0]}`;

    editIndex=index;
    editKey=key;
    toggleForm();
}

function deleteMovement(index,key){
    if(!confirm("Â¿Borrar movimiento?")) return;
    movements[key].splice(index,1);
    save();
    render();
}

function clearForm(){
    document.getElementById("date").value="";
    document.getElementById("detail").value="";
    document.getElementById("debe").value="";
    document.getElementById("haber").value="";
}

function toggleDark(){
    document.body.classList.toggle("dark");
}

/* Swipe meses */
document.addEventListener("touchstart",e=>{
    startX=e.touches[0].clientX;
});

document.addEventListener("touchend",e=>{
    let endX=e.changedTouches[0].clientX;
    let diff=startX-endX;

    if(Math.abs(diff)>60){
        if(diff>0){
            currentDate.setMonth(currentDate.getMonth()+1);
        }else{
            currentDate.setMonth(currentDate.getMonth()-1);
        }
        render();
    }
});

render();

if('serviceWorker' in navigator){
    navigator.serviceWorker.register('service-worker.js');
}
</script>

</body>
</html>
